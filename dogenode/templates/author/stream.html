{% extends "user_base.html" %}

{% block body %}

    <script type="text/javascript">
        $(document).ready(function() {
            /* the CSRF stuff is from:
             * https://docs.djangoproject.com/en/1.6/ref/contrib/csrf/#ajax
             * TODO: find a better way to do this cleanly...
             */
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            var csrftoken = getCookie('csrftoken');
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                crossDomain: false, // obviates need for sameOrigin test
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type)) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            /**
             * Generates a GUID string
             * @returns {String} The generated GUID.
             * @example af8a8416-6e18-a307-bd9c-f2c947bbb3aa
             * @author Slavik Melster (slavik@meltser.info),
             *link http://slavik.meltser.info/?p=142
             */
            function generateGUID() {
                function _p8(s) {
                    var p = (Math.random().toString(16)+"000000000").substr(2,8);
                    return s ? "-"  + p.substr(0,4) + "-" + p.substr(4,4): p;
                }
                return _p8() + _p8(true) + _p8(true) + _p8();
            }

            // On click of make new post button, send an AJAX PUT request to create post
            $("#makePost").on("click", function() {
                var guid = generateGUID();
                // var images = TODO XXX: DEAL WITH IMAGES
                var postData = JSON.stringify({
                    "guid": guid,
                    "title": $("#title").val(),
                    "text": $("#description").val(),
                    "content": $("#content").val(),
                    "categories": $("#categories").val(),
                    "privacyOptions": $("#privacyOptions").val(),
                    "visibilityExceptions": $("#visibilityExceptions").val(),
                    "content-type": $("#content-type").val(), 
                });  
                
                // send ajax request
                $.ajax({
                    type: "PUT",
                    url: "http://127.0.0.1:8000/api/post/" + guid + "/",
                    data: postData,
                    dataType: "json",
                    contentType: "application/json",
                    success: function(response) {
                        var title = response["title"];
                        // var source = response["source"]; TODO XXX:add source field
                        var origin = response["origin"];
                        var description = response["description"];
                        var contentType = response["contentType"];
                        var content = response["content"];
			var author = response["author"];
			var categories = response["categories"];
			var comments = response["comments"];
			var pubDate = response["pubDate"];
			var guid = response["guid"];
			var visibility = response["visibility"];
			
			// deal with categories
			var catHTML = "";
			if (categories.length > 0) {
                            var postWidth = '<div class="col-sm-8 col-md-10">';
			    catHTML += '<div class="col-sm-4 col-md-2 text-right">';
			    // building html for categories
                            for (cat in categories) {
				catHTML += '<span class="label label-default">' 
				    +   categories[cat] + '</span>';
			    }    
			    catHTML += '</div>';
			} else {
			    var postWidth = '<div class="col-sm-12">';
                        }   
			
			// deal with images
			var imagesHTML = "";
			//if (len(images) > 0) {
			//    contentSize = '<div class="col-sm-8 col-lg-9">';
			//    imagesHTML += '<div class="col-sm-4 col-lg-3 text-center">'
			//	+ '<div class="well">';
//			    for (img in images) {   TODO XXX: FIX THIS!!!
//				 imagesHTML += '<a href='{{ image.file.url }}?{% now "U" %}' target="_blank"><img class="img-responsive-horizontal" src="{{ image.file.url }}?{% now 'U' %}"/></a>
//			    }
			//    imagesHTML += '</div></div>';
			    
			//} else {
			//    contentSize = '<div class="col-sm-12">';
			//}
			var contentSize = '<div class="col-sm-12">';

			var commentsHTML = "";
			// deal with comments
                        for (comment in comments) {
                           commentsHTML += '<tr>'
				+ '<td><small>'
				+  '<a href="' + comments[comment]["author"]["url"] + '">'
				+    '<strong>' + comments[comment]["author"]["displayname"] 
				+    '</strong>'
				+  '</a> on ' + comments[comment]["pubDate"] + '</small>'
				+ '</td></tr>';
                        }
 

                        // add new post to stream
                        $(".stream-title").after('<div class="row">'
			 +  '<div class="col-md-12">'
			 +   '<div class="panel panel-default">'
			 +      '<div class="panel-heading">'
			 +        '<div class="row">'
                         +         postWidth
			 +         '<h4><strong>' + title + '</strong></h4>'
			 +         '<h5>' + description + '</h5>'
                         +         '</div>'
			 +         catHTML
                         +       '</div>'
                         +      '</div>'
                         +      '<div class="panel-body">'
                         +        '<div class="row">'
                         +          contentSize
			 +           content
                         +          '</div>'
			 +           imagesHTML
                         +        '</div>'
                         +      '</div>'
                         +      '<div class="panel-footer">'
                         +        '<div class="row">'
                         +          '<div class="col-sm-4">'
                         +            'by <a href="' + author["url"] + '">'
                         +               '<strong>' + author["displayname"] + '</strong>'
                         +               '</a>'
                         +            'on' + pubDate 
			 +          '</div>'
                         +          '<div class="col-sm-8 text-right">'
                         +            '<a href="' + origin + '" class="text-muted">'
                         +              origin
                         +            '</a>'
                         +          '</div>'
                         +        '</div>'
                         +      '</div>'
                         +      '<table class="table">'
                         +        '<tbody>'
			 +         commentsHTML
			 +        '</tbody>'
                         +      '</table>'
                         +      '<div class="panel-footer">'
                         +        '<form role="form" method="POST"'
                         +         ' action="/comments/add_comment/">'
                      //   +          '{% csrf_token %}'
                         +          '<div class="form-group">'
                         +            '<input type="hidden" name="post_id" value="' + guid + '" />'
                         +            '<input type="text" class="form-control" name="newComment"'
                         +             ' placeholder="Make a new comment..." required/>'
                         +          '</div>'
                         +          '<div class="form-group">'
                         +            '<input type="submit" value="Comment"/>'
                         +          '</div>'
                         +        '</form>'
                         +      '</div>'
                         +    '</div>'
                         +  '</div>'
			 + '</div>');
			},
                    error: function(xhr, status, error) {
                        console.log(xhr.responseText);
                    }
                });
                return false;

            });
            
        });
        
    </script>

<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="row">
        <div class="col-md-12"><p></p></div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <form class="form-horizontal" role="form">
                <div class="panel panel-default">
                  {% csrf_token %}
                  <div class="panel-heading">
                      <h4><strong>Make New Post</strong></h4>
                  </div>
                  <div class="panel-body">
                      <div class="form-group">
                          <label for="title" class="col-sm-2 col-lg-1 control-label">Title:</label>
                          <div class="col-sm-10 col-lg-11">
                              <input type="text" class="form-control" id="title" name="title" required/>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="description" class="col-sm-2 col-lg-1 control-label" style="overflow: hidden; word-wrap: break-word;">Description:</label>
                          <div class="col-sm-10 col-lg-11">
                              <input type="text" class="form-control" id="description" name="description"/>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="content" class="col-sm-2 col-lg-1 control-label">Content:</label>
                          <div class="col-sm-10 col-lg-11">
                              <textarea class="form-control" id="content" name="content"
                               placeholder="Make a new post..." required></textarea>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="categories" class="col-sm-2 col-lg-1 control-label">Categories:</label>
                          <div class="col-sm-10 col-lg-11">
                              <input type="text" class="form-control" id="categories" name="categories" placeholder="Enter categories separated by spaces"/>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="image" class="col-sm-2 col-lg-1 control-label">Images:</label>
                          <div class="col-sm-10 col-lg-11">
                              <input type="file" id="image" name="image" accept="image/*" multiple="multiple"/>
                              <span class="help-block">CTRL+Click to select multiple files</span>
                          </div>
                      </div>
                  </div>
                  <div class="panel-footer">
                      <div class="form-group" id="privacyOptions">
                          <label for="visibility" class="control-label col-sm-2 col-lg-1">Viewable by:</label>
                          <div class="col-sm-3 col-md-2 col-lg-2">
                            <select id="visibility" name="visibility" class="form-control">
                            {% for option in visibilities %}
                                <option value="{{ option.0 }}">{{ option.1 }}</option>
                            {% endfor %}
                            </select>
                          </div>
                          <label for="visibilityExceptions" class="control-label col-sm-1 col-lg-1" style="text-align: center">and</label>
                          <div class="col-sm-3 col-md-4">
                              <input type="text" class="form-control" 
                               id="visibilityExceptions" 
                               name="visibilityExceptions"
                               placeholder="Enter names(s) separated by spaces"/>
                          </div>
                      </div>
                      <div class="form-group" id="visibilityOptions">
                      </div>

                      <div class="form-group" id="contentTypeOptions">
                          <label for="content-type" class="col-sm-2 col-lg-1 control-label">Format:</label>
                          <div class="col-sm-3 col-md-2">
                              <select id="content-type" name="content-type" class="form-control">
                              {% for type in contentTypes %}
                                  <option value="{{ type.0 }}">{{ type.1 }}</option>
                              {% endfor %}
                              </select>
                          </div>
                          <div class="col-sm-offset-5 col-sm-1 col-md-offset-6 col-lg-offset-8">
                              <input type="button" id="makePost" value="Post"/>
                          </div>
                      </div>
                  </div>
                </div>
            </form>
        </div>
     </div>
    <div class="row stream-title">
        <div class="col-md-12">
            <header>
                <h3>My Stream \o/</h3>
            </header>
        </div>
    </div>

    {% include 'fragments/post_content.html' %}
</div>
{% endblock %}
